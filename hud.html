<!doctype html>
<meta charset="utf-8">
<title>Mentor HUD</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
  /* Fill the media viewport */
  html, body { height:100%; margin:0; }
  body { background:#111; color:#eee; font:14px Arial,Helvetica,sans-serif; }

  /* Shell fills the entire media area */
  .shell {
    position:absolute; left:0; top:0; right:0; bottom:0;
    padding:10px; box-sizing:border-box;
  }

  /* Panels occupy full height */
  .panel {
    height:100%; box-sizing:border-box;
    border:1px solid #334; background:#1a1f27; border-radius:12px; padding:10px;
  }
  .hidden { display:none; }

  .row    { margin:8px 0; }
  .subtle { color:#b7c1cc; }
  .badge  { float:right; padding:3px 8px; border:1px solid #2b3344; border-radius:999px; background:#182028; color:#9ac2ff; font-size:12px; }
  .clear  { clear:both; }

  /* Message area – JS will resize this to fill leftover space */
  .msg {
    height:320px;               /* safe baseline; JS will override */
    overflow:auto;
    border:1px solid #334; background:#0b0f14;
    border-radius:8px; padding:8px; white-space:pre-wrap;
  }

  /* Buttons: stacked; use .half for 2-up row */
  .btn {
    display:block; width:100%;
    padding:10px 12px; margin:6px 0;
    border:1px solid #2b3344; background:#182028; color:#eee;
    border-radius:8px; cursor:pointer; text-align:center; font-weight:bold;
  }
  .btn:active { position:relative; top:1px; }
  .btnRowCenter { text-align:center; }
  .half { display:inline-block; width:48%; margin:6px 1%; }
</style>

<div class="shell">
  <!-- Minimised view -->
  <div id="minView" class="panel">
    <div class="row" style="text-align:center;font-weight:bold">Mentor Assist</div>
    <div id="miniStatus" class="row subtle" style="text-align:center">No messages</div>
    <div class="row">
      <button type="button" class="btn" onclick="hudOpen()">Open</button>
      <button type="button" class="btn" id="miniNotifyBtn" onclick="toggleNotify()">Notify OFF</button>
    </div>
  </div>

  <!-- Maximised view -->
  <div id="maxView" class="panel hidden">
    <div class="row">
      <strong>Mentor Assist</strong>
      <span id="notifyChip" class="badge">Notify: OFF</span>
      <div class="clear"></div>
    </div>

    <div id="from" class="row subtle">From: —</div>
    <div id="msg" class="msg">No active request.</div>

    <div class="row">
      <button type="button" class="btn" onclick="acceptReq()">Accept</button>
      <button type="button" class="btn" onclick="declineReq()">Decline</button>
    </div>

    <div class="row btnRowCenter">
      <button type="button" class="btn half" onclick="hudMin()">Minimise</button>
      <button type="button" class="btn half" id="notifyBtn" onclick="toggleNotify()">Turn ON</button>
    </div>
  </div>
</div>

<script>
/* ===== Helpers (ES5-safe) ===== */
function el(id){ return document.getElementById(id); }
function setText(n,t){ if('textContent'in n) n.textContent=t; else n.innerText=t; }
function show(id,on){ el(id).className = on ? 'panel' : 'panel hidden'; }

function parseQuery(){
  var s=(window.location.search||'').replace(/^\?/,'');
  var out={}, p, i, kv, k, v; if(!s) return out;
  p=s.split('&');
  for(i=0;i<p.length;i++){
    kv=p[i].split('=');
    k=decodeURIComponent(kv[0]||''); v=decodeURIComponent(kv[1]||'');
    if(k) out[k]=v;
  }
  return out;
}
function parseHash(){
  var h=(window.location.hash||'').replace(/^#/,'');
  var out={}, p, i, kv, k, v; if(!h) return out;
  p=h.split('&');
  for(i=0;i<p.length;i++){
    kv=p[i].split('=');
    k=decodeURIComponent(kv[0]||''); v=decodeURIComponent(kv[1]||'');
    if(k) out[k]=v;
  }
  return out;
}

/* ===== State ===== */
var notifyOn=false;
var current=null; // {name, message, incoming, locked}
var CB=(function(){ var q=parseQuery(); return q.cb||''; })();

/* ===== Rendering ===== */
function render(){
  var isMax=(window.__view==='max');
  show('maxView', isMax);
  show('minView', !isMax);

  setText(el('notifyChip'), 'Notify: ' + (notifyOn ? 'ON' : 'OFF'));
  setText(el('notifyBtn'),  notifyOn ? 'Turn OFF' : 'Turn ON');
  setText(el('miniNotifyBtn'), notifyOn ? 'Notify ON' : 'Notify OFF');

  if(!current){
    setText(el('from'),'From: —');
    setText(el('msg'),'No active request.');
    setText(el('miniStatus'),'No messages');
    return;
  }
  setText(el('from'),'From: ' + current.name);
  setText(el('msg'), current.message);
  setText(el('miniStatus'), current.incoming ? ('From ' + current.name) : 'No messages');
}

/* ===== Actions ===== */
function setView(v){ window.__view=(v==='max')?'max':'min'; render(); }
function toggleNotify(){ notifyOn=!notifyOn; render(); }
function setMessage(p){
  current = p ? { name:(p.name||'—'), message:(p.message||''), incoming:!!p.incoming, locked:false } : null;
  render();
}
function acceptReq(){ if(!current) return; current.locked=true; render(); }
function declineReq(){ current=null; render(); }

/* ===== Callback to LSL (Open/Minimise) ===== */
function sendToLSL(action){
  if(!CB) return false; // desktop preview: no callback
  var url = CB + "?act=" + encodeURIComponent(action) + "&t=" + (new Date()).getTime();
  window.location.href = url; // full navigation (works in MOAP)
  return true;
}
function hudOpen(){ if(!sendToLSL('maximise')) setView('max'); }
function hudMin(){  if(!sendToLSL('minimise')) setView('min'); }

/* ===== Resize: make message fill remaining space ===== */
function resizeMsg(){
  var panel = el('maxView');
  var msg   = el('msg');
  if(!panel || !msg) return;

  // Total available height inside panel
  var total = panel.clientHeight || panel.offsetHeight || 540;

  // Distance from top of panel to top of msg box
  var top = 0, node = msg;
  while (node && node !== panel) { top += node.offsetTop||0; node = node.offsetParent; }

  // Space to reserve below the msg (buttons area) – tweak if needed
  var reservedBottom = 120;

  var h = total - top - reservedBottom;
  if (h < 120) h = 120;
  msg.style.height = h + "px";
}

/* ===== Init from hash ===== */
(function init(){
  setView('min');
  notifyOn=false;
  setMessage(null);

  var h=parseHash();
  if(h.view) setView(h.view);
  if(h.notify!=null) notifyOn=(h.notify==='1'||h.notify==='true');
  if(h.name!=null || h.msg!=null){
    setMessage({ name:(h.name||'—'), message:(h.msg||''), incoming:(h.incoming==='1'||h.incoming==='true') });
  } else {
    render();
  }

  // Initial sizing + on-resize
  resizeMsg();
  if (window.addEventListener) window.addEventListener('resize', resizeMsg, false);
  else if (window.attachEvent) window.attachEvent('onresize', resizeMsg);
})();
</script>
