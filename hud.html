<script>
(function(){
  // --- helpers (ES5-safe) ---
  function byId(id){ return document.getElementById(id); }
  function hasClass(el, c){ return (' ' + el.className + ' ').indexOf(' ' + c + ' ') > -1; }
  function addClass(el, c){ if (!hasClass(el,c)) el.className = (el.className ? el.className+' ' : '') + c; }
  function removeClass(el, c){ el.className = (' ' + el.className + ' ').replace(' ' + c + ' ', ' ').trim(); }
  function setClass(el, c, on){ if (on) addClass(el,c); else removeClass(el,c); }

  function parseHash(){
    var h = window.location.hash.replace(/^#/,'');
    var out = {};
    if (!h) return out;
    var parts = h.split('&');
    for (var i=0;i<parts.length;i++){
      var kv = parts[i].split('=');
      var k = decodeURIComponent(kv[0]||'');
      var v = decodeURIComponent(kv[1]||'');
      if (k) out[k] = v;
    }
    return out;
  }
  function setHashParam(k,v){
    var p = parseHash();
    p[k] = v;
    var a=[], key;
    for (key in p){ if (p.hasOwnProperty(key) && p[key] !== undefined && p[key] !== null) {
      a.push(encodeURIComponent(key)+'='+encodeURIComponent(p[key]));
    }}
    window.location.hash = '#' + a.join('&');
  }

  var root = byId('HUD');
  var msgEl = byId('msg');
  var fromEl = byId('from');
  var notifyChip = byId('notifyChip');
  var btnAccept = byId('btnAccept');
  var btnDecline = byId('btnDecline');
  var btnNotify = byId('btnNotify');
  var btnMin = byId('btnMinimise');
  var btnMax = byId('btnMaximise');
  var miniNotify = byId('btnMiniNotify');
  var miniMax = byId('btnMiniMax');
  var miniBox = byId('minibox');
  var miniStatus = byId('miniStatus');

  var state = {
    view: 'min',
    notifyOn: false,
    current: null,
    lastAction: null
  };

  function applyView(){
    setClass(root, 'min', state.view === 'min');
    setClass(root, 'max', state.view === 'max');
    btnMax.style.display = (state.view === 'min') ? '' : 'none';
    btnMin.style.display = (state.view === 'max') ? '' : 'none';
  }

  function setNotify(on){
    state.notifyOn = !!on;
    setClass(notifyChip, 'ok', state.notifyOn);
    setClass(notifyChip, 'off', !state.notifyOn);
    notifyChip.textContent = 'Notify: ' + (state.notifyOn ? 'ON' : 'OFF');
    btnNotify.textContent = state.notifyOn ? 'Turn OFF' : 'Turn ON';
    miniNotify.textContent = state.notifyOn ? 'Notify ON' : 'Notify OFF';
  }

  function setMessage(payload){
    if (!payload){
      state.current = null;
      renderMessage();
      return;
    }
    state.current = {
      name: payload.name || '—',
      message: payload.message || '',
      incoming: !!payload.incoming,
      locked: false
    };
    renderMessage();
  }

  function renderMessage(){
    if (!state.current){
      fromEl.textContent = 'From: —';
      msgEl.textContent = 'No active request.';
      miniStatus.textContent = 'No messages';
      removeClass(miniBox, 'alertPulse');
      btnAccept.disabled = false;
      btnDecline.disabled = false;
      return;
    }
    fromEl.textContent = 'From: ' + state.current.name;
    msgEl.textContent = state.current.message;
    miniStatus.textContent = state.current.incoming ? ('From ' + state.current.name) : 'No messages';

    if (state.view === 'min' && state.current.incoming && state.notifyOn){
      addClass(miniBox, 'alertPulse');
    } else {
      removeClass(miniBox, 'alertPulse');
    }
    btnAccept.disabled = !!state.current.locked;
    btnDecline.disabled = !!state.current.locked;
  }

  function setView(v){
    state.view = (v === 'max') ? 'max' : 'min';
    applyView();
    renderMessage();
  }

  function signal(action){
    state.lastAction = { type: action, ts: (new Date()).getTime() };
    try {
      setHashParam('act', action);
      setHashParam('ts', state.lastAction.ts);
      if (state.current){ setHashParam('resident', state.current.name); }
    } catch(e){}
  }

  // Button handlers
  btnAccept.onclick = function(){
    if (!state.current) return;
    state.current.locked = true;
    renderMessage();
    signal('accept');
  };
  btnDecline.onclick = function(){
    state.current = null;
    renderMessage();
    signal('decline');
  };
  btnNotify.onclick = function(){
    setNotify(!state.notifyOn);
    renderMessage();
    signal(state.notifyOn ? 'notify_on' : 'notify_off');
  };
  btnMin.onclick = function(){
    setView('min');
    signal('minimise');
  };
  btnMax.onclick = function(){
    setView('max');
    signal('maximise');
  };
  miniMax.onclick = function(){
    setView('max');
    signal('maximise');
  };
  miniNotify.onclick = function(){
    setNotify(!state.notifyOn);
    renderMessage();
    signal(state.notifyOn ? 'notify_on' : 'notify_off');
  };

  function readHash(){
    try{
      var q = parseHash();
      var v = q.view;
      var on = q.notify;
      var name = q.name;
      var message = q.msg;
      var incoming = q.incoming;
      if (v) setView(v);
      if (on != null) setNotify(on === '1' || on === 'true');
      if (name != null || message != null){
        setMessage({ name: name || '—', message: message || '', incoming: (incoming === '1' || incoming === 'true') });
      }
    }catch(e){}
  }
  if (window.addEventListener) {
    window.addEventListener('hashchange', readHash, false);
  } else if (window.attachEvent) {
    window.attachEvent('onhashchange', readHash);
  }

  // Initial paint
  setView('min'); setNotify(false); setMessage(null); readHash();
})();
</script>
