<!doctype html>
<meta charset="utf-8">
<title>Mentor HUD</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
  /* Simple, MOAP-friendly CSS (no CSS variables, grid, or flex required) */
  html, body { height:100%; }
  body{ margin:0; background:#111; color:#eee; font:14px Arial,Helvetica,sans-serif; }
  .wrap{ padding:8px; }
  .panel{ border:1px solid #334; background:#1a1f27; border-radius:10px; padding:8px; }
  .hidden{ display:none; }
  .row{ margin:6px 0; }
  .right{ float:right; }
  .clear{ clear:both; }
  .btn{
    padding:6px 10px; margin:2px;
    border:1px solid #2b3344; background:#182028; color:#eee; border-radius:8px; cursor:pointer;
  }
  .btn:active{ position:relative; top:1px; }
  .msg{
    height:140px; overflow:auto;
    border:1px solid #334; background:#0b0f14; border-radius:8px; padding:6px;
    white-space:pre-wrap;
  }
</style>

<div class="wrap">
  <!-- Minimised view -->
  <div id="minView" class="panel">
    <div id="miniStatus" class="row" style="text-align:center">No messages</div>
    <div class="row" style="text-align:center">
      <button type="button" class="btn" onclick="hudOpen()">Open</button>
      <button type="button" class="btn" id="miniNotifyBtn" onclick="toggleNotify()">Notify OFF</button>
    </div>
  </div>

  <!-- Maximised view -->
  <div id="maxView" class="panel hidden">
    <div class="row">
      <strong>Mentor Assist</strong>
      <span id="notifyChip" class="right">Notify: OFF</span>
      <div class="clear"></div>
    </div>
    <div class="row" id="from">From: —</div>
    <div id="msg" class="msg">No active request.</div>
    <div class="row">
      <button type="button" class="btn" onclick="acceptReq()">Accept</button>
      <button type="button" class="btn" onclick="declineReq()">Decline</button>
      <button type="button" class="btn right" id="notifyBtn" onclick="toggleNotify()">Turn ON</button>
      <button type="button" class="btn right" onclick="hudMin()" style="margin-right:6px">Minimise</button>
      <div class="clear"></div>
    </div>
  </div>
</div>

<script>
/* ====== Helpers (ES5-safe) ====== */
function el(id){ return document.getElementById(id); }
function setText(node, txt){
  if ('textContent' in node) node.textContent = txt;
  else node.innerText = txt;
}
function show(id, on){
  el(id).className = on ? 'panel' : 'panel hidden';
}
function parseQuery(){
  var s = (window.location.search||'').replace(/^\?/,'');
  var out = {}; if (!s) return out;
  var parts = s.split('&'), i, kv, k, v;
  for (i=0;i<parts.length;i++){
    kv = parts[i].split('=');
    k = decodeURIComponent(kv[0]||''); v = decodeURIComponent(kv[1]||'');
    if (k) out[k] = v;
  }
  return out;
}
function parseHash(){
  var h = (window.location.hash||'').replace(/^#/,'');
  var out = {}; if (!h) return out;
  var parts = h.split('&'), i, kv, k, v;
  for (i=0;i<parts.length;i++){
    kv = parts[i].split('=');
    k = decodeURIComponent(kv[0]||''); v = decodeURIComponent(kv[1]||'');
    if (k) out[k] = v;
  }
  return out;
}

/* ====== State ====== */
var notifyOn = false;
var current = null; // {name, message, incoming, locked}
var CB = (function(){ var q=parseQuery(); return q.cb||''; })();

/* ====== Rendering ====== */
function render(){
  // views
  var isMax = (window.__view === 'max');
  show('maxView', isMax);
  show('minView', !isMax);

  // notify badges/buttons
  setText(el('notifyChip'), 'Notify: ' + (notifyOn ? 'ON' : 'OFF'));
  setText(el('notifyBtn'),  notifyOn ? 'Turn OFF' : 'Turn ON');
  setText(el('miniNotifyBtn'), notifyOn ? 'Notify ON' : 'Notify OFF');

  // message content
  if (!current){
    setText(el('from'), 'From: —');
    setText(el('msg'), 'No active request.');
    setText(el('miniStatus'), 'No messages');
    return;
  }
  setText(el('from'), 'From: ' + current.name);
  setText(el('msg'), current.message);
  setText(el('miniStatus'), current.incoming ? ('From ' + current.name) : 'No messages');
}

/* ====== Public-ish actions ====== */
function setView(v){
  window.__view = (v === 'max') ? 'max' : 'min';
  render();
}
function toggleNotify(){
  notifyOn = !notifyOn;
  render();
}
function setMessage(p){
  current = p ? {
    name: (p.name || '—'),
    message: (p.message || ''),
    incoming: !!p.incoming,
    locked: false
  } : null;
  render();
}
function acceptReq(){
  if (!current) return;
  current.locked = true;
  render();
}
function declineReq(){
  current = null;
  render();
}

/* ====== Callback to LSL (Open/Minimise) ====== */
function sendToLSL(action){
  if (!CB) return false; // desktop preview: no callback provided
  // Full navigation so SL's MOAP will hit your http_request handler
  var url = CB + "?act=" + encodeURIComponent(action) + "&t=" + (new Date()).getTime();
  window.location.href = url;
  return true;
}
function hudOpen(){ if (!sendToLSL('maximise')) setView('max'); }
function hudMin(){  if (!sendToLSL('minimise')) setView('min'); }

/* ====== Initialisation from URL hash ====== */
(function init(){
  // defaults
  setView('min');
  notifyOn = false;
  setMessage(null);

  var h = parseHash();
  if (h.view) setView(h.view);
  if (h.notify != null) notifyOn = (h.notify === '1' || h.notify === 'true');
  if (h.name != null || h.msg != null){
    setMessage({
      name: (h.name || '—'),
      message: (h.msg || ''),
      incoming: (h.incoming === '1' || h.incoming === 'true')
    });
  } else {
    render();
  }
})();
</script>
